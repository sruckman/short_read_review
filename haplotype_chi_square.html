<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Founder Haplotype Effect Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #333;
        }
        .plot-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        canvas {
            border: 1px solid #ddd;
            cursor: crosshair;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #0064a4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #004d7f;
        }
        .info {
            text-align: center;
            color: #666;
            margin-top: 10px;
            font-size: 13px;
        }
        label {
            margin: 0 10px;
        }
        input[type="number"], select {
            width: 100px;
            padding: 5px;
            margin: 0 5px;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 25px;
            height: 15px;
            border: 1px solid #333;
        }
        .stats-panel {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 13px;
        }
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>8-Founder Multiparent Panel: Haplotype Effect Visualization</h2>
        
        <div class="controls">
            <label>Trait Type: 
                <select id="traitType">
                    <option value="quantitative">Quantitative</option>
                    <option value="binary">Binary (Case/Control)</option>
                </select>
            </label>
            <label>Number of Blocks: <input type="number" id="numBlocks" value="50" min="20" max="200"></label>
            <label>Effect Size: 
                <select id="effectSize">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                </select>
            </label>
            <label>QTL Regions: <input type="number" id="numQTL" value="2" min="1" max="5"></label>
            <button onclick="generateData()">Generate New Data</button>
            <button onclick="downloadImage()">Download Chi-Square Plot</button>
            <button onclick="downloadEffectPlot()">Download Effect Plot</button>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span>Founder A</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>Founder B</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2ecc71;"></div>
                <span>Founder C</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f39c12;"></div>
                <span>Founder D</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9b59b6;"></div>
                <span>Founder E</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #1abc9c;"></div>
                <span>Founder F</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e91e63;"></div>
                <span>Founder G</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #795548;"></div>
                <span>Founder H</span>
            </div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <strong>Hover over a point to see detailed statistics</strong>
        </div>
        
        <div class="plot-container">
            <div style="flex: 1;">
                <h3 style="text-align: center; font-size: 14px;">Chi-Square Statistics (df=7)</h3>
                <canvas id="chiSquareCanvas" width="750" height="400"></canvas>
            </div>
            <div style="flex: 1;">
                <h3 style="text-align: center; font-size: 14px;">Founder Haplotype Effects</h3>
                <canvas id="effectCanvas" width="750" height="400"></canvas>
            </div>
        </div>
        
        <div class="info">
            <p><strong>Left plot:</strong> Chi-square test statistic for each haplotype block (red line: p=0.05 threshold, χ²=14.07 for df=7)</p>
            <p><strong>Right plot:</strong> Individual founder haplotype effect lines showing which founders increase/decrease the trait at each position</p>
            <p>Hover over points for detailed founder effects and frequencies.</p>
        </div>
    </div>

    <script>
        const chiCanvas = document.getElementById('chiSquareCanvas');
        const chiCtx = chiCanvas.getContext('2d');
        const effectCanvas = document.getElementById('effectCanvas');
        const effectCtx = effectCanvas.getContext('2d');
        
        let haplotypeData = [];
        let hoveredBlock = null;
        
        const founderColors = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12',
            '#9b59b6', '#1abc9c', '#e91e63', '#795548'
        ];
        
        const founderNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        
        function calculateChiSquare(founderEffects, founderFreqs, traitType) {
            // Simulate chi-square based on effect sizes and frequencies
            let chiSquare = 0;
            const avgEffect = founderEffects.reduce((a, b) => a + b, 0) / 8;
            
            for (let i = 0; i < 8; i++) {
                const deviation = Math.abs(founderEffects[i] - avgEffect);
                const weight = founderFreqs[i];
                chiSquare += deviation * deviation * weight * 100;
            }
            
            // Add some noise - REDUCED FOR CLEANER DATA
            chiSquare += (Math.random() - 0.5) * 4;
            return Math.max(0, chiSquare);
        }
        
        function generateFounderEffects(position, numBlocks, qtlRegions, effectSize) {
            const effects = [];
            let baselineEffect = 0;
            
            // Check if this position is in a QTL region
            let inQTL = false;
            let qtlStrength = 0;
            
            for (let qtl of qtlRegions) {
                const distance = Math.abs(position - qtl.center);
                if (distance < qtl.width) {
                    inQTL = true;
                    // Gaussian effect
                    qtlStrength = Math.exp(-Math.pow(distance / (qtl.width / 3), 2));
                    break;
                }
            }
            
            // Effect size multiplier
            const effectMultiplier = {
                'small': 0.5,
                'medium': 1.0,
                'large': 2.0
            }[effectSize];
            
            // Generate effects for each founder
            for (let i = 0; i < 8; i++) {
                if (inQTL) {
                    // Assign specific effects to founders in QTL regions
                    if (i < 2) {
                        // Founders A, B have positive effects
                        effects.push(qtlStrength * (2 + Math.random()) * effectMultiplier);
                    } else if (i < 4) {
                        // Founders C, D have negative effects
                        effects.push(-qtlStrength * (2 + Math.random()) * effectMultiplier);
                    } else {
                        // Founders E-H have neutral/small effects
                        effects.push((Math.random() - 0.5) * 0.5 * effectMultiplier);
                    }
                } else {
                    // Background noise - REDUCED FOR CLEANER DATA
                    effects.push((Math.random() - 0.5) * 0.75);
                }
            }
            
            return effects;
        }
        
        function generateFounderFrequencies() {
            // Generate realistic founder frequencies (with some variation)
            const baseFreq = 1/8;
            const freqs = [];
            let sum = 0;
            
            for (let i = 0; i < 8; i++) {
                const freq = baseFreq + (Math.random() - 0.5) * 0.05;
                freqs.push(Math.max(0.02, freq));
                sum += freqs[i];
            }
            
            // Normalize to sum to 1
            return freqs.map(f => f / sum);
        }
        
        function generateData() {
            const numBlocks = parseInt(document.getElementById('numBlocks').value);
            const numQTL = parseInt(document.getElementById('numQTL').value);
            const traitType = document.getElementById('traitType').value;
            const effectSize = document.getElementById('effectSize').value;
            
            haplotypeData = [];
            
            // Generate QTL regions
            const qtlRegions = [];
            for (let i = 0; i < numQTL; i++) {
                qtlRegions.push({
                    center: Math.random() * numBlocks,
                    width: 3 + Math.random() * 5  // 3-8 blocks wide
                });
            }
            
            let currentPosition = 0;
            
            for (let i = 0; i < numBlocks; i++) {
                const blockSize = 10 + Math.random() * 40; // 10-50 kb
                const startPos = currentPosition;
                const endPos = currentPosition + blockSize;
                
                const founderEffects = generateFounderEffects(i, numBlocks, qtlRegions, effectSize);
                const founderFreqs = generateFounderFrequencies();
                const chiSquare = calculateChiSquare(founderEffects, founderFreqs, traitType);
                
                haplotypeData.push({
                    id: `Block_${i + 1}`,
                    startPos: startPos,
                    endPos: endPos,
                    blockSize: blockSize,
                    position: i,
                    centerPos: (startPos + endPos) / 2,
                    founderEffects: founderEffects,
                    founderFreqs: founderFreqs,
                    chiSquare: chiSquare
                });
                
                currentPosition = endPos;
            }
            
            drawPlots();
        }
        
        function drawChiSquarePlot() {
            if (haplotypeData.length === 0) return;
            
            const padding = { top: 30, right: 30, bottom: 50, left: 70 };
            const plotWidth = chiCanvas.width - padding.left - padding.right;
            const plotHeight = chiCanvas.height - padding.top - padding.bottom;
            
            // Clear canvas
            chiCtx.fillStyle = '#ffffff';
            chiCtx.fillRect(0, 0, chiCanvas.width, chiCanvas.height);
            
            const threshold = 14.07; // Chi-square critical value for df=7, p=0.05
            const maxChiSquare = Math.max(...haplotypeData.map(h => h.chiSquare), threshold + 5);
            const totalGenomicLength = haplotypeData[haplotypeData.length - 1].endPos;
            
            // Draw grid
            chiCtx.strokeStyle = '#e0e0e0';
            chiCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight / 5) * i;
                chiCtx.beginPath();
                chiCtx.moveTo(padding.left, y);
                chiCtx.lineTo(chiCanvas.width - padding.right, y);
                chiCtx.stroke();
            }
            
            // Draw threshold line
            const thresholdY = padding.top + plotHeight - (threshold / maxChiSquare) * plotHeight;
            chiCtx.strokeStyle = '#e74c3c';
            chiCtx.lineWidth = 2;
            chiCtx.setLineDash([5, 5]);
            chiCtx.beginPath();
            chiCtx.moveTo(padding.left, thresholdY);
            chiCtx.lineTo(chiCanvas.width - padding.right, thresholdY);
            chiCtx.stroke();
            chiCtx.setLineDash([]);
            
            // Draw line graph segment by segment for color change
            haplotypeData.forEach((block, index) => {
                if (index === 0) return;

                const prevBlock = haplotypeData[index - 1];
                
                const x1 = padding.left + (prevBlock.centerPos / totalGenomicLength) * plotWidth;
                const y1 = padding.top + plotHeight - (prevBlock.chiSquare / maxChiSquare) * plotHeight;
                const x2 = padding.left + (block.centerPos / totalGenomicLength) * plotWidth;
                const y2 = padding.top + plotHeight - (block.chiSquare / maxChiSquare) * plotHeight;

                const isPrevSignificant = prevBlock.chiSquare > threshold;
                const isCurrentSignificant = block.chiSquare > threshold;

                chiCtx.beginPath();
                chiCtx.moveTo(x1, y1);
                chiCtx.lineTo(x2, y2);
                
                chiCtx.strokeStyle = (isPrevSignificant && isCurrentSignificant) ? '#e74c3c' : '#3498db';
                chiCtx.lineWidth = 2;
                chiCtx.stroke();
            });
            
            // Draw points
            haplotypeData.forEach((block) => {
                const x = padding.left + (block.centerPos / totalGenomicLength) * plotWidth;
                const y = padding.top + plotHeight - (block.chiSquare / maxChiSquare) * plotHeight;
                
                const isSignificant = block.chiSquare > threshold;
                const isHovered = hoveredBlock && hoveredBlock.id === block.id;
                
                chiCtx.beginPath();
                chiCtx.arc(x, y, isHovered ? 6 : 4, 0, 2 * Math.PI);
                chiCtx.fillStyle = isHovered ? '#f39c12' : (isSignificant ? '#e74c3c' : '#3498db');
                chiCtx.fill();
                chiCtx.strokeStyle = '#fff';
                chiCtx.lineWidth = 1;
                chiCtx.stroke();
            });
            
            // Draw axes
            chiCtx.strokeStyle = '#333';
            chiCtx.lineWidth = 2;
            chiCtx.beginPath();
            chiCtx.moveTo(padding.left, padding.top);
            chiCtx.lineTo(padding.left, chiCanvas.height - padding.bottom);
            chiCtx.lineTo(chiCanvas.width - padding.right, chiCanvas.height - padding.bottom);
            chiCtx.stroke();
            
            // Y-axis labels
            chiCtx.fillStyle = '#333';
            chiCtx.font = '11px Arial';
            chiCtx.textAlign = 'right';
            chiCtx.textBaseline = 'middle';
            for (let i = 0; i <= 5; i++) {
                const value = (maxChiSquare / 5) * (5 - i);
                const y = padding.top + (plotHeight / 5) * i;
                chiCtx.fillText(value.toFixed(1), padding.left - 10, y);
            }
            
            // X-axis labels
            chiCtx.textAlign = 'center';
            chiCtx.textBaseline = 'top';
            for (let i = 0; i <= 5; i++) {
                const x = padding.left + (plotWidth / 5) * i;
                const posKb = Math.floor((totalGenomicLength / 5) * i);
                chiCtx.fillText(posKb, x, chiCanvas.height - padding.bottom + 10);
            }
            
            // Axis titles
            chiCtx.font = '12px Arial';
            chiCtx.fillText('Genomic Position (kb)', chiCanvas.width / 2, chiCanvas.height - 15);
            
            chiCtx.save();
            chiCtx.translate(20, chiCanvas.height / 2);
            chiCtx.rotate(-Math.PI / 2);
            chiCtx.fillText('χ² Statistic', 0, 0);
            chiCtx.restore();
            
            // Threshold label
            chiCtx.fillStyle = '#e74c3c';
            chiCtx.font = '10px Arial';
            chiCtx.textAlign = 'left';
            chiCtx.fillText('p=0.05', chiCanvas.width - padding.right + 5, thresholdY);
        }
        
        function drawEffectPlot() {
            if (haplotypeData.length === 0) return;
            
            const padding = { top: 30, right: 30, bottom: 50, left: 70 };
            const plotWidth = effectCanvas.width - padding.left - padding.right;
            const plotHeight = effectCanvas.height - padding.top - padding.bottom;
            
            // Clear canvas
            effectCtx.fillStyle = '#ffffff';
            effectCtx.fillRect(0, 0, effectCanvas.width, effectCanvas.height);
            
            const totalGenomicLength = haplotypeData[haplotypeData.length - 1].endPos;
            
            // Find max absolute effect for scaling
            let maxEffect = 0;
            haplotypeData.forEach(block => {
                block.founderEffects.forEach(effect => {
                    maxEffect = Math.max(maxEffect, Math.abs(effect));
                });
            });
            maxEffect = Math.max(maxEffect, 2); // Minimum scale
            
            // Draw grid
            effectCtx.strokeStyle = '#e0e0e0';
            effectCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight / 5) * i;
                effectCtx.beginPath();
                effectCtx.moveTo(padding.left, y);
                effectCtx.lineTo(effectCanvas.width - padding.right, y);
                effectCtx.stroke();
            }
            
            // Draw zero line
            const zeroY = padding.top + plotHeight / 2;
            effectCtx.strokeStyle = '#333';
            effectCtx.lineWidth = 1.5;
            effectCtx.setLineDash([3, 3]);
            effectCtx.beginPath();
            effectCtx.moveTo(padding.left, zeroY);
            effectCtx.lineTo(effectCanvas.width - padding.right, zeroY);
            effectCtx.stroke();
            effectCtx.setLineDash([]);
            
            // Draw line for each founder
            for (let founderIdx = 0; founderIdx < 8; founderIdx++) {
                effectCtx.strokeStyle = founderColors[founderIdx];
                effectCtx.lineWidth = 2;
                effectCtx.globalAlpha = 0.7;
                effectCtx.beginPath();
                
                haplotypeData.forEach((block, index) => {
                    const x = padding.left + (block.centerPos / totalGenomicLength) * plotWidth;
                    const effect = block.founderEffects[founderIdx];
                    const y = zeroY - (effect / maxEffect) * (plotHeight / 2);
                    
                    if (index === 0) {
                        effectCtx.moveTo(x, y);
                    } else {
                        effectCtx.lineTo(x, y);
                    }
                });
                effectCtx.stroke();
            }
            
            effectCtx.globalAlpha = 1.0;
            
            // Draw points for hovered block
            if (hoveredBlock) {
                haplotypeData.forEach((block) => {
                    if (block.id === hoveredBlock.id) {
                        const x = padding.left + (block.centerPos / totalGenomicLength) * plotWidth;
                        
                        for (let founderIdx = 0; founderIdx < 8; founderIdx++) {
                            const effect = block.founderEffects[founderIdx];
                            const y = zeroY - (effect / maxEffect) * (plotHeight / 2);
                            
                            effectCtx.beginPath();
                            effectCtx.arc(x, y, 5, 0, 2 * Math.PI);
                            effectCtx.fillStyle = founderColors[founderIdx];
                            effectCtx.fill();
                            effectCtx.strokeStyle = '#000';
                            effectCtx.lineWidth = 1.5;
                            effectCtx.stroke();
                        }
                    }
                });
            }
            
            // Draw axes
            effectCtx.strokeStyle = '#333';
            effectCtx.lineWidth = 2;
            effectCtx.beginPath();
            effectCtx.moveTo(padding.left, padding.top);
            effectCtx.lineTo(padding.left, effectCanvas.height - padding.bottom);
            effectCtx.lineTo(effectCanvas.width - padding.right, effectCanvas.height - padding.bottom);
            effectCtx.stroke();
            
            // Y-axis labels
            effectCtx.fillStyle = '#333';
            effectCtx.font = '11px Arial';
            effectCtx.textAlign = 'right';
            effectCtx.textBaseline = 'middle';
            for (let i = 0; i <= 5; i++) {
                const value = maxEffect * (1 - 2 * i / 5);
                const y = padding.top + (plotHeight / 5) * i;
                effectCtx.fillText(value.toFixed(1), padding.left - 10, y);
            }
            
            // X-axis labels
            effectCtx.textAlign = 'center';
            effectCtx.textBaseline = 'top';
            for (let i = 0; i <= 5; i++) {
                const x = padding.left + (plotWidth / 5) * i;
                const posKb = Math.floor((totalGenomicLength / 5) * i);
                effectCtx.fillText(posKb, x, effectCanvas.height - padding.bottom + 10);
            }
            
            // Axis titles
            effectCtx.font = '12px Arial';
            effectCtx.fillText('Genomic Position (kb)', effectCanvas.width / 2, effectCanvas.height - 15);
            
            effectCtx.save();
            effectCtx.translate(20, effectCanvas.height / 2);
            effectCtx.rotate(-Math.PI / 2);
            effectCtx.fillText('Founder Effect Size', 0, 0);
            effectCtx.restore();
        }
        
        function drawPlots() {
            drawChiSquarePlot();
            drawEffectPlot();
        }
        
        function updateStatsPanel(block) {
            const panel = document.getElementById('statsPanel');
            if (!block) {
                panel.innerHTML = '<strong>Hover over a point to see detailed statistics</strong>';
                return;
            }
            
            const pValue = 1 - jStat.chisquare.cdf(block.chiSquare, 7);
            const pValueStr = pValue < 0.001 ? '< 0.001' : pValue.toFixed(4);
            
            let html = `<strong>${block.id}</strong> | Position: ${block.startPos.toFixed(0)}-${block.endPos.toFixed(0)} kb | `;
            html += `χ² = ${block.chiSquare.toFixed(2)} (df=7, p=${pValueStr})<br>`;
            html += '<div class="stats-row">';
            
            for (let i = 0; i < 8; i++) {
                const effect = block.founderEffects[i];
                const freq = block.founderFreqs[i];
                const color = founderColors[i];
                const sign = effect >= 0 ? '+' : '';
                html += `<span style="color: ${color}; font-weight: bold;">
                    ${founderNames[i]}: ${sign}${effect.toFixed(2)} (${(freq*100).toFixed(1)}%)
                </span>`;
            }
            
            html += '</div>';
            panel.innerHTML = html;
        }
        
        function findBlockAtPosition(canvas, e) {
            if (haplotypeData.length === 0) return null;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const padding = { left: 70, right: 30, top: 30, bottom: 50 };
            const plotWidth = canvas.width - padding.left - padding.right;
            const totalGenomicLength = haplotypeData[haplotypeData.length - 1].endPos;
            
            let closestBlock = null;
            let minDistance = Infinity;
            
            for (let block of haplotypeData) {
                const blockX = padding.left + (block.centerPos / totalGenomicLength) * plotWidth;
                const distance = Math.abs(x - blockX);
                
                if (distance < minDistance && distance < 20) { // 20px threshold
                    minDistance = distance;
                    closestBlock = block;
                }
            }
            
            return closestBlock;
        }
        
        // Mouse event handlers
        chiCanvas.addEventListener('mousemove', function(e) {
            const block = findBlockAtPosition(chiCanvas, e);
            if (block !== hoveredBlock) {
                hoveredBlock = block;
                updateStatsPanel(block);
                drawPlots();
            }
        });
        
        effectCanvas.addEventListener('mousemove', function(e) {
            const block = findBlockAtPosition(effectCanvas, e);
            if (block !== hoveredBlock) {
                hoveredBlock = block;
                updateStatsPanel(block);
                drawPlots();
            }
        });
        
        chiCanvas.addEventListener('mouseleave', function() {
            hoveredBlock = null;
            updateStatsPanel(null);
            drawPlots();
        });
        
        effectCanvas.addEventListener('mouseleave', function() {
            hoveredBlock = null;
            updateStatsPanel(null);
            drawPlots();
        });
        
        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'haplotype_chisquare.png';
            link.href = chiCanvas.toDataURL();
            link.click();
        }
        
        function downloadEffectPlot() {
            const link = document.createElement('a');
            link.download = 'founder_effects.png';
            link.href = effectCanvas.toDataURL();
            link.click();
        }
        
        // Simple chi-square CDF implementation (jStat substitute)
        const jStat = {
            chisquare: {
                cdf: function(x, df) {
                    // Approximation for chi-square CDF
                    if (x <= 0) return 0;
                    const k = df / 2;
                    const x2 = x / 2;
                    
                    // Using incomplete gamma function approximation
                    let sum = 0;
                    let term = Math.exp(-x2) * Math.pow(x2, k) / this.gamma(k + 1);
                    
                    for (let i = 0; i < 100; i++) {
                        sum += term;
                        term *= x2 / (k + i + 1);
                        if (term < 1e-10) break;
                    }
                    
                    return Math.min(1, sum);
                },
                gamma: function(n) {
                    // Stirling's approximation
                    if (n < 1) return Math.PI / Math.sin(Math.PI * n) / this.gamma(1 - n);
                    if (n < 12) {
                        let prod = 1;
                        while (n > 1) {
                            n--;
                            prod *= n;
                        }
                        return prod;
                    }
                    return Math.sqrt(2 * Math.PI / n) * Math.pow(n / Math.E, n);
                }
            }
        };
        
        // Generate initial data on load
        window.addEventListener('load', function() {
            generateData();
        });
    </script>
</body>
</html>