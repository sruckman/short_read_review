<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNP Chi-Square Visualization (Updated Styling)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #333;
        }
        canvas {
            border: 1px solid #ddd;
            display: block;
            margin: 20px auto;
            cursor: crosshair;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #0064a4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #004d7f;
        }
        .info {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }
        label {
            margin: 0 10px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
            margin: 0 5px;
        }
        .threshold-info {
            text-align: center;
            margin: 10px 0;
            font-size: 12px;
            color: #666;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 10px 0;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>SNP-by-SNP Chi-Square Visualization</h2>
        
        <div class="controls">
            <label>Number of SNPs: <input type="number" id="numSNPs" value="500" min="50" max="2000"></label>
            <label>Significance Threshold (χ²): <input type="number" id="threshold" value="7.88" step="0.01" min="0"></label>
            <button onclick="generateData()">Generate New Data</button>
            <button onclick="downloadImage()">Download Image</button>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>Non-significant</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span>Significant (above threshold)</span>
            </div>
            <div class="legend-item">
                <div style="width: 20px; height: 2px; background-color: #000000; border: none;"></div>
                <span>Threshold line</span>
            </div>
        </div>
        
        <canvas id="chiSquareCanvas" width="1200" height="500"></canvas>
        
        <div class="threshold-info">
            <p><strong>Common thresholds:</strong> χ² = 3.84 (p=0.05, df=1) | χ² = 6.63 (p=0.01, df=1) | χ² = 7.88 (p=0.005, df=1) | χ² = 10.83 (p=0.001, df=1)</p>
        </div>
        
        <div class="info">
            <p>Each point represents a SNP's chi-square statistic. Higher values indicate stronger association.</p>
            <p>Hover over points to see SNP details. Red points exceed the significance threshold.</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('chiSquareCanvas');
        const ctx = canvas.getContext('2d');
        
        let snpData = [];
        let hoveredSNP = null;
        
        function generateChiSquare() {
            const randomValue = Math.random() * 3.5;
            return randomValue * randomValue;
        }
        
        function generateData() {
            const numSNPs = parseInt(document.getElementById('numSNPs').value);
            snpData = [];
            
            for (let i = 0; i < numSNPs; i++) {
                snpData.push({
                    id: `rs${1000000 + i}`,
                    position: i,
                    chiSquare: generateChiSquare(),
                    chromosome: Math.floor(i / (numSNPs / 22)) + 1
                });
            }
            
            drawPlot();
        }
        
        function drawPlot() {
            const threshold = parseFloat(document.getElementById('threshold').value);
            const padding = { top: 40, right: 40, bottom: 60, left: 80 };
            const plotWidth = canvas.width - padding.left - padding.right;
            const plotHeight = canvas.height - padding.top - padding.bottom;
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const maxChiSquare = Math.max(...snpData.map(s => s.chiSquare), threshold + 5);
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(canvas.width - padding.right, y);
                ctx.stroke();
            }
            
            // Draw threshold line in black, with no label
            const thresholdY = padding.top + plotHeight - (threshold / maxChiSquare) * plotHeight;
            ctx.strokeStyle = '#000000'; // Changed to black
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding.left, thresholdY);
            ctx.lineTo(canvas.width - padding.right, thresholdY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // SNP points
            snpData.forEach((snp, index) => {
                const x = padding.left + (snp.position / snpData.length) * plotWidth;
                const y = padding.top + plotHeight - (snp.chiSquare / maxChiSquare) * plotHeight;
                
                const isSignificant = snp.chiSquare > threshold;
                ctx.fillStyle = isSignificant ? '#e74c3c' : '#3498db';
                
                if (hoveredSNP && hoveredSNP.id === snp.id) {
                    ctx.fillStyle = '#f39c12';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                } else {
                    ctx.beginPath();
                    ctx.arc(x, y, 2.5, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, canvas.height - padding.bottom);
            ctx.lineTo(canvas.width - padding.right, canvas.height - padding.bottom);
            ctx.stroke();
            
            // Y-axis labels (larger font)
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial'; // Changed from 12px
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i <= 5; i++) {
                const value = (maxChiSquare / 5) * (5 - i);
                const y = padding.top + (plotHeight / 5) * i;
                ctx.fillText(value.toFixed(1), padding.left - 15, y);
            }
            
            // X-axis labels (larger font)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            // Font already set to 14px from Y-axis
            const numLabels = 10;
            for (let i = 0; i <= numLabels; i++) {
                const x = padding.left + (plotWidth / numLabels) * i;
                const snpNum = Math.floor((snpData.length / numLabels) * i);
                ctx.fillText(snpNum, x, canvas.height - padding.bottom + 10);
            }
            
            // Axis titles (larger font)
            ctx.font = '18px Arial'; // Changed from 14px
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText('SNP Position', canvas.width / 2, canvas.height - 25);
            
            ctx.save();
            ctx.translate(30, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Chi-Square Statistic (χ²)', 0, 0);
            ctx.restore();
            
            // Hovered SNP info
            if (hoveredSNP) {
                const x = padding.left + (hoveredSNP.position / snpData.length) * plotWidth;
                const y = padding.top + plotHeight - (hoveredSNP.chiSquare / maxChiSquare) * plotHeight;
                
                const text = `${hoveredSNP.id} | χ² = ${hoveredSNP.chiSquare.toFixed(2)} | Chr ${hoveredSNP.chromosome}`;
                const textWidth = ctx.measureText(text).width;
                
                let tooltipX = x + 10;
                let tooltipY = y - 30;
                
                if (tooltipX + textWidth + 20 > canvas.width - padding.right) {
                    tooltipX = x - textWidth - 30;
                }
                
                if (tooltipY < padding.top) {
                    tooltipY = y + 10;
                }
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(tooltipX, tooltipY, textWidth + 20, 25);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, tooltipX + 10, tooltipY + 12);
            }
        }
        
        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'snp_chi_square_plot.png';
            link.href = canvas.toDataURL();
            link.click();
        }
        
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const padding = { top: 40, right: 40, bottom: 60, left: 80 };
            const plotWidth = canvas.width - padding.left - padding.right;
            const plotHeight = canvas.height - padding.top - padding.bottom;
            const maxChiSquare = Math.max(...snpData.map(s => s.chiSquare), parseFloat(document.getElementById('threshold').value) + 5);
            
            let closestSNP = null;
            let minDist = 15;
            
            snpData.forEach(snp => {
                const snpX = padding.left + (snp.position / snpData.length) * plotWidth;
                const snpY = padding.top + plotHeight - (snp.chiSquare / maxChiSquare) * plotHeight;
                const dist = Math.sqrt((x - snpX) ** 2 + (y - snpY) ** 2);
                
                if (dist < minDist) {
                    minDist = dist;
                    closestSNP = snp;
                }
            });
            
            if (closestSNP !== hoveredSNP) {
                hoveredSNP = closestSNP;
                drawPlot();
            }
        });
        
        canvas.addEventListener('mouseleave', function() {
            if (hoveredSNP) {
                hoveredSNP = null;
                drawPlot();
            }
        });
        
        generateData();
    </script>
</body>
</html>