---
title: "A Practical Guide to Estimating Heritability and Evolvability"
author: "Sarah Ruckman"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Introduction

This guide provides R code for estimating heritability and evolvability using common experimental designs. Each section assumes you have a comma-separated values (CSV) file containing your phenotype data in the specified format. The code is designed to be easily adapted to your own data.

Before running the code, ensure you have the necessary R packages installed. The `lme4` package is required for mixed-effects models.

```{r install_packages, eval=FALSE}
# Run this code once if you don't have the lme4 package installed
install.packages("lme4")
```

---

# Part 1: Narrow-Sense Heritability (h²) and Evolvability from Pedigrees

These methods are used in populations with known family structures. They allow for the estimation of narrow-sense heritability (h²), which considers only additive genetic variance, and the Coefficient of Additive Genetic Variation (CVA), a measure of evolvability.

## A. Parent-Offspring Regression

This method estimates h² by regressing offspring phenotypes on parental phenotypes. The slope of the relationship is proportional to the heritability.

#### Data Format (`parent_offspring.csv`)
A CSV file with two columns: `phenotype_parent` and `phenotype_offspring`. For mid-parent regression, use the average of the two parents as `phenotype_parent`.

| phenotype_parent | phenotype_offspring |
|:-----------------|:--------------------|
| 10.5             | 10.8                |
| 9.8              | 10.1                |
| ...              | ...                 |

#### R Code
```{r parent_offspring, eval=FALSE}
# Read the data
po_data <- read.csv("parent_offspring.csv")

# Fit a linear model: Offspring Phenotype ~ Parent Phenotype
model <- lm(phenotype_offspring ~ phenotype_parent, data = po_data)

# --- Heritability (h²) ---
# For a single parent, the slope is (1/2)h², so we multiply by 2.
# For mid-parent regression, the slope is h², so you would not multiply by 2.
slope <- coef(model)["phenotype_parent"]
h2 <- 2 * slope

# Calculate 95% Confidence Interval for the slope and scale it
ci_h2 <- 2 * confint(model, "phenotype_parent", level = 0.95)

cat("Narrow-Sense Heritability (h²):", h2, "\n")
cat("95% CI for h²:", ci_h2[1], "-", ci_h2[2], "\n\n")

# --- Evolvability (CVA) ---
# Phenotypic variance of the offspring generation
Vp_offspring <- var(po_data$phenotype_offspring)
# Additive genetic variance (Va = h² * Vp)
Va <- h2 * Vp_offspring
# Trait mean of the offspring
mean_offspring <- mean(po_data$phenotype_offspring)
# Coefficient of Additive Genetic Variation (CVA)
CVA <- (100 * sqrt(Va)) / mean_offspring
cat("Evolvability (CVA):", CVA, "%\n")
```

## B. Half-Sib ANOVA

In a half-sib design (e.g., multiple dams mated to each sire), h² can be estimated by partitioning variance components using a linear mixed model. The variance among sires is proportional to the additive genetic variance.

#### Data Format (`half_sib.csv`)
A CSV file with columns for `sire_ID`, `dam_ID`, and `phenotype`.

| sire_ID | dam_ID | phenotype |
|:--------|:-------|:----------|
| Sire1   | Dam1A  | 10.2      |
| Sire1   | Dam1B  | 9.9       |
| Sire2   | Dam2A  | 11.5      |
| ...     | ...    | ...       |

#### R Code
```{r half_sib, eval=FALSE}
library(lme4)

# Read the data
sib_data <- read.csv("half_sib.csv")

# Fit a mixed model with sire as a random effect
model <- lmer(phenotype ~ (1 | sire_ID), data = sib_data)

# Extract variance components
variances <- as.data.frame(VarCorr(model))
var_sire <- variances[variances$grp == "sire_ID", "vcov"]
var_residual <- variances[variances$grp == "Residual", "vcov"]

# --- Heritability (h²) ---
# Additive genetic variance (Va) = 4 * var_sire
# Total phenotypic variance (Vp) = var_sire + var_residual
h2 <- (4 * var_sire) / (var_sire + var_residual)
cat("Narrow-Sense Heritability (h²):", h2, "\n")

# --- Evolvability (CVA) ---
Va <- 4 * var_sire
trait_mean <- mean(sib_data$phenotype)
CVA <- (100 * sqrt(Va)) / trait_mean
cat("Evolvability (CVA):", CVA, "%\n")
```

---

# Part 2: Realized Heritability (h²) from Artificial Selection

This method calculates realized heritability from a one-generation selection experiment using the breeder's equation (R = h²S). This approach is most efficient under **truncation selection**, where the selection differential (S) can be calculated without measuring the selected parents, using only the proportion of the population selected.

#### Data Format (`selection_experiment.csv`)
A CSV file with two columns: `group` (identifying the initial and offspring populations) and `phenotype`. This method does **not** require data from the selected parents.

| group     | phenotype |
|:----------|:----------|
| initial   | 10.1      |
| initial   | 10.5      |
| offspring | 10.8      |
| offspring | 11.1      |
| ...       | ...       |

#### R Code
```{r realized_h2, eval=FALSE}
# Read the data
sel_data <- read.csv("selection_experiment.csv")

# --- 1. Define Experimental Parameters ---
# Set the proportion of the population selected as parents.
# For example, 0.2 means the top 20% were selected.
proportion_selected <- 0.2

# --- 2. Calculate Response to Selection (R) ---
initial_phenotypes <- sel_data$phenotype[sel_data$group == "initial"]
offspring_phenotypes <- sel_data$phenotype[sel_data$group == "offspring"]

mean_initial <- mean(initial_phenotypes)
mean_offspring <- mean(offspring_phenotypes)

# R is the change in the population mean across one generation
R <- mean_offspring - mean_initial

# --- 3. Calculate Selection Differential (S) ---
# S = i * σₚ, where i is selection intensity and σₚ is phenotypic standard deviation.

# Phenotypic standard deviation (σₚ) of the initial population
sd_initial <- sd(initial_phenotypes)

# Selection intensity (i) from the proportion selected.
# This assumes the phenotype is normally distributed.
# i = z/p, where z is the height of the normal curve at the truncation point.
selection_intensity <- dnorm(qnorm(1 - proportion_selected)) / proportion_selected

# Now, calculate S
S <- selection_intensity * sd_initial

# --- 4. Calculate Heritability and Evolvability ---
# Realized Heritability (h²)
h2 <- R / S
cat("Realized Heritability (h²):", h2, "\n")

# Mean-Standardized Evolvability (a measure of the proportional response)
evolvability <- R / mean_initial
cat("Mean-Standardized Evolvability (R/mean):", evolvability, "\n")
```

---

# Part 3: Broad-Sense Heritability (H²) from Replicated Lines

This method is for genetically stable lines (e.g., RILs, inbred lines, clones) and estimates *broad-sense* heritability (H²), which includes all genetic variance (additive, dominance, and epistatic).

#### Data Format (`replicated_lines.csv`)
A CSV file with two columns: `line_ID` and `phenotype`.

| line_ID | phenotype |
|:--------|:----------|
| RIL_1   | 15.3      |
| RIL_1   | 14.9      |
| RIL_2   | 12.1      |
| ...     | ...       |

#### R Code
```{r broad_sense_h2, eval=FALSE}
library(lme4)

# Read the data
ril_data <- read.csv("replicated_lines.csv")

# Fit a mixed model with line_ID as a random effect
model <- lmer(phenotype ~ (1 | line_ID), data = ril_data)

# Extract variance components
variances <- as.data.frame(VarCorr(model))
var_genetic <- variances[variances$grp == "line_ID", "vcov"] # Total genetic variance (Vg)
var_residual <- variances[variances$grp == "Residual", "vcov"] # Environmental variance (Ve)

# --- Broad-Sense Heritability (H²) ---
H2 <- var_genetic / (var_genetic + var_residual)
cat("Broad-Sense Heritability (H²):", H2, "\n")

# --- Optional: Bootstrap for Confidence Interval ---
# This is computationally intensive but provides robust CIs.
n_boot <- 1000
H2_boot <- numeric(n_boot)

for (i in 1:n_boot) {
  # Resample data with replacement (by line_ID to maintain structure)
  lines <- unique(ril_data$line_ID)
  boot_lines <- sample(lines, size = length(lines), replace = TRUE)
  
  boot_data <- do.call(rbind, lapply(boot_lines, function(l) ril_data[ril_data$line_ID == l, ]))
  
  # Refit model on bootstrapped data
  boot_model <- lmer(phenotype ~ (1 | line_ID), data = boot_data)
  
  # Recalculate H²
  boot_vars <- as.data.frame(VarCorr(boot_model))
  boot_vg <- boot_vars[boot_vars$grp == "line_ID", "vcov"]
  boot_ve <- boot_vars[boot_vars$grp == "Residual", "vcov"]
  H2_boot[i] <- boot_vg / (boot_vg + boot_ve)
}

# Calculate 95% CI from the bootstrap distribution
ci_boot <- quantile(H2_boot, c(0.025, 0.975), na.rm = TRUE)
cat("Bootstrapped 95% CI for H²:", ci_boot[1], "-", ci_boot[2], "\n")

```

**Note on Evolvability:** Evolvability (CVA) requires an estimate of the *additive* genetic variance (Vₐ). This method estimates *total* genetic variance (V₉), which includes dominance and epistatic effects. Therefore, CVA cannot be directly calculated from these results.